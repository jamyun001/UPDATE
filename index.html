<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>체르 평지생존 : 리바이브</title>
  <style>
    :root {
      --bg: #f9fbfd;
      --card: #e8ecf1;
      --hover: #d4dae3;
      --text: #222;
      --accent: #007aff;
    }
    body.dark {
      --bg: #121212;
      --card: #1e1e1e;
      --hover: #2a2a2a;
      --text: #eee;
      --accent: #00e1ff;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
      line-height: 1.4;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 1.2rem 1rem;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    h1 {
      text-align: center;
      color: var(--accent);
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    .theme-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: var(--accent);
    }
    .notice-item {
      background: var(--card);
      padding: 0.8rem 1rem;
      border-radius: 12px;
      margin-bottom: 0.6rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.2s ease;
    }
    .notice-item:hover {
      background: var(--hover);
      transform: scale(1.02);
    }
    .notice-title {
      font-weight: 600;
    }
    .notice-preview {
      font-size: 0.9rem;
      color: gray;
      margin-top: 0.2rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #detail-view {
      display: none;
      animation: fadeIn 0.3s ease;
      flex-direction: column;
    }
    .back-button {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 1rem;
      padding: 0;
      align-self: flex-start;
    }
    #notice-body {
      font-size: 1rem;
      line-height: 1.5;
      margin-bottom: 2rem;
      white-space: pre-wrap;
    }
    /* 댓글 스타일 */
    #comments-section {
      margin-top: 2rem;
    }
    #comments-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 0.5rem;
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
    }
    #comments-list > div {
      border-bottom: 1px solid #ddd;
      padding: 0.3rem 0;
    }
    #comments-list > div:last-child {
      border-bottom: none;
    }
    #comment-input {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
      font-family: 'Segoe UI', sans-serif;
    }
    #submit-comment {
      margin-top: 0.5rem;
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 600px) {
      .container {
        padding: 1rem;
      }
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
    <h1>📢 공지사항</h1>
    <div id="list-view"></div>

    <div id="detail-view">
      <button class="back-button" onclick="goBack()">← 목록으로</button>
      <div id="notice-body"></div>

      <!-- 댓글 섹션 -->
      <div id="comments-section">
        <h3>댓글</h3>
        <div id="comments-list">댓글 로딩 중...</div>
        <textarea id="comment-input" rows="3" placeholder="댓글을 입력하세요..."></textarea>
        <button id="submit-comment">댓글 등록</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyAPVJcXblj0MzeSWhJomvl8xczyp2Unp6w",
      authDomain: "chating-382e3.firebaseapp.com",
      projectId: "chating-382e3",
      storageBucket: "chating-382e3.appspot.com",
      messagingSenderId: "690140086247",
      appId: "1:690140086247:web:4635c4c0315f465c110742",
      measurementId: "G-SD2QM11LHC"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 공지 md 목록
    const mdList = ["V1.0.md", "V1.0.1.md", "V1.1.md", "V2.0.md"];

    // 버전 오름차순 정렬 함수 (3자리까지 지원, 숫자 크기로 제대로 정렬)
    function versionSortAsc(a, b) {
      const toNums = v => v.replace(/^V/, "").replace(/\.md$/, "").split('.').map(n => parseInt(n, 10));
      const aNums = toNums(a);
      const bNums = toNums(b);
      for (let i = 0; i < Math.max(aNums.length, bNums.length); i++) {
        const aVal = aNums[i] || 0;
        const bVal = bNums[i] || 0;
        if (aVal !== bVal) return aVal - bVal;
      }
      return 0;
    }
    mdList.sort(versionSortAsc);

    const listView = document.getElementById('list-view');
    const detailView = document.getElementById('detail-view');
    const noticeBody = document.getElementById('notice-body');
    let currentNoticeId = null;

    // HTML 이스케이프 함수 (XSS 방지)
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[m]);
    }

    // 마크다운 간단 변환 (#, ##, -, 줄바꿈)
    function markdownToHtml(md) {
      return md
        .replace(/^# (.*)$/gm, '<h2>$1</h2>')
        .replace(/^## (.*)$/gm, '<h3>$1</h3>')
        .replace(/^- (.*)$/gm, '<li>$1</li>')
        .replace(/\n{2,}/g, '</p><p>')
        .replace(/\n/g, '<br>');
    }

    // 공지 목록 렌더링
    mdList.forEach(filename => {
      fetch(`updates/${filename}`)
        .then(r => r.text())
        .then(text => {
          const title = filename.replace(".md","");
          // 첫 의미있는 줄 찾아서 미리보기
          const preview = text.split('\n').find(l => l.trim().length > 0) || '';
          const shortPreview = preview.length > 60 ? preview.slice(0, 60) + '...' : preview;

          const div = document.createElement('div');
          div.className = 'notice-item';
          div.innerHTML = `<div class="notice-title">✅ ${escapeHtml(title)}</div><div class="notice-preview">${escapeHtml(shortPreview)}</div>`;
          div.onclick = () => loadNotice(filename);
          listView.appendChild(div);
        });
    });

    // 댓글 UI 요소
    const commentsList = document.getElementById('comments-list');
    const commentInput = document.getElementById('comment-input');
    const submitCommentBtn = document.getElementById('submit-comment');

    // 댓글 불러오기
    async function loadComments(noticeId) {
      commentsList.innerHTML = '댓글 로딩 중...';

      try {
        const snapshot = await db.collection('comments').doc(noticeId).collection('comments')
          .orderBy('createdAt', 'desc')
          .get();

        if (snapshot.empty) {
          commentsList.innerHTML = '<p>댓글이 없습니다.</p>';
          return;
        }

        commentsList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement('div');

          const date = data.createdAt ? data.createdAt.toDate().toLocaleString() : '';

          div.innerHTML = `
            <strong>${escapeHtml(data.name || '익명')}</strong> <small style="color: gray;">${date}</small>
            <p style="margin: 0.3rem 0 0 0;">${escapeHtml(data.text)}</p>
          `;
          commentsList.appendChild(div);
        });
      } catch (error) {
        commentsList.innerHTML = '<p>댓글을 불러오는 중 오류가 발생했습니다.</p>';
        console.error('댓글 로드 오류:', error);
      }
    }

    // 댓글 등록
    async function submitComment() {
      const text = commentInput.value.trim();
      if (!text) {
        alert('댓글 내용을 입력하세요.');
        return;
      }

      const commentData = {
        text,
        name: '익명',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('comments').doc(currentNoticeId).collection('comments').add(commentData);
        commentInput.value = '';
        loadComments(currentNoticeId);
      } catch (error) {
        alert('댓글 등록 중 오류가 발생했습니다.');
        console.error('댓글 등록 오류:', error);
      }
    }

    submitCommentBtn.addEventListener('click', submitComment);

    // 공지 로드
    function loadNotice(filename) {
      currentNoticeId = filename;
      fetch(`updates/${filename}`)
        .then(r => r.text())
        .then(md => {
          noticeBody.innerHTML = markdownToHtml(md);
          listView.style.display = 'none';
          detailView.style.display = 'flex';

          loadComments(currentNoticeId);
        });
    }

    // 뒤로가기
    function goBack() {
      detailView.style.display = 'none';
      listView.style.display = 'flex';
      currentNoticeId = null;
      commentsList.innerHTML = '';
      commentInput.value = '';
    }

    // 테마 토글
    const toggleBtn = document.querySelector('.theme-toggle');
    toggleBtn.addEventListener('click', toggleTheme);
    (function applySavedTheme() {
      if(localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark');
        toggleBtn.textContent = '☀️';
      }
    })();
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      toggleBtn.textContent = isDark ? '☀️' : '🌙';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
  </script>
</body>
</html>
